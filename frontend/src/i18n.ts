import { useMemo } from 'react'
import { useStore } from './store/useStore'
import { formatDate as formatDateUtil, formatMonthLabel as formatMonthLabelUtil, formatRelativeToNow as formatRelativeToNowUtil } from './utils/format'
import type { Settings } from './types'

type Locale = Settings['locale']

const en = {
  'app.loading': 'Warming up your subscriptions...',
  'nav.dashboard': 'Dashboard',
  'nav.subscriptions': 'Subscriptions',
  'nav.archive': 'Archive',
  'nav.settings': 'Settings',
  'nav.importJson': 'Import JSON',
  'nav.export': 'Export',
  'nav.addSubscription': 'Add subscription',
  'nav.openMenu': 'Open menu',
  'nav.closeMenu': 'Close menu',
  'nav.menuTitle': 'Navigation menu',
  'nav.exportReady.title': 'Export ready',
  'nav.exportReady.description': 'Your subscriptions were exported as JSON.',
  'nav.importComplete.title': 'Import complete',
  'nav.importComplete.description': 'Subscriptions have been loaded from your file.',
  'nav.importFailed.title': 'Import failed',
  'nav.importFailed.description': 'We could not read that file. Check it is a valid SubsKeeper export.',
  'nav.importFailed.invalidJson': 'The file is not valid JSON.',
  'nav.importFailed.invalidStructure': 'The file does not match the SubsKeeper export schema.',
  'nav.importFailed.empty': 'The file was empty. Export data first before importing.',
  'nav.tagline': 'Track every recurring payment with ease',
  'import.ariaLabel': 'Import subscriptions from JSON',
  'footer.offline': 'operates entirely offline. Your data stays in your browser.',
  'footer.tagline': 'Made with mindful spending in mind.',
  'filters.searchLabel': 'Search',
  'filters.searchPlaceholder': 'Name, vendor, notes...',
  'filters.sortLabel': 'Sort',
  'filters.sort.nextDue': 'Next due',
  'filters.sort.priceDesc': 'Price high → low',
  'filters.sort.priceAsc': 'Price low → high',
  'filters.sort.name': 'Alphabetical',
  'filters.sort.createdAt': 'Recently added',
  'filters.statusLabel': 'Status',
  'filters.status.all': 'All',
  'filters.categoryLabel': 'Category',
  'filters.category.any': 'Any',
  'filters.vendorLabel': 'Vendor',
  'filters.vendor.any': 'Any',
  'filters.minPrice': 'Min price',
  'filters.maxPrice': 'Max price',
  'filters.reset': 'Reset filters',
  'subscription.vendorUnknown': 'Vendor unknown',
  'subscription.monthlyPrice': 'Monthly price',
  'subscription.nextRenewal': 'Next renewal',
  'subscription.dueIn': '{count} days',
  'subscription.duePast': '{count} days past',
  'subscription.category': 'Category',
  'subscription.notes': 'Notes',
  'subscription.edit': 'Edit',
  'subscription.archive': 'Archive',
  'subscription.restore': 'Restore',
  'subscription.delete': 'Delete',
  'status.active': 'Active',
  'status.canceled': 'Canceled',
  'status.expired': 'Expired',
  'status.archived': 'Archived',
  'stats.activeLineup': 'Active lineup',
  'stats.archivedCount': '{count} resting in the archive',
  'stats.reminders': 'Reminders',
  'stats.remindersDescription': 'Due soon or overdue based on your reminder window',
  'stats.monthlySpend': 'Monthly spend',
  'stats.monthlySpendEmpty': 'Add subscriptions to see totals.',
  'stats.normalized': 'Normalized to USD',
  'stats.normalizedDescription': 'Using fixed FX table inside the app.',
  'sparkline.title': '12-month trail',
  'sparkline.empty': 'Add subscriptions to populate the sparkline.',
  'reminders.queue': 'Reminder queue',
  'reminders.badge': '{count} due',
  'reminders.empty': 'All caught up! Adjust your reminder window in settings to see upcoming renewals.',
  'reminders.due': 'Due {date}',
  'reminders.overdue': '{count} days overdue',
  'reminders.left': '{count} days left',
  'reminders.review': 'Review',
  'reminders.snooze': 'Snooze 7 days',
  'reminders.clearSnooze': 'Clear snooze',
  'reminders.toast.snoozeError.title': 'Could not snooze',
  'reminders.toast.snoozeError.description': 'We could not postpone this reminder. Please try again.',
  'reminders.toast.clearError.title': 'Could not clear reminder',
  'reminders.toast.clearError.description': 'Please refresh the page and try again.',
  'toast.close': 'Close',
  'subscriptions.emptyTitle': 'No subscriptions',
  'subscriptions.emptyDescription': 'Adjust filters or add your first subscription to get started.',
  'subscriptions.emptyAction': 'Add subscription',
  'subscriptions.confirmDeleteTitle': 'Delete subscription?',
  'subscriptions.confirmDeleteDescription': 'This action cannot be undone.',
  'subscriptions.confirmDeleteConfirm': 'Delete',
  'subscriptions.toast.archived.title': 'Archived',
  'subscriptions.toast.archived.description': 'Subscription moved to archive.',
  'subscriptions.toast.removed.title': 'Removed',
  'subscriptions.toast.removed.description': 'Subscription deleted permanently.',
  'subscriptions.toast.archivedError.title': 'Archive failed',
  'subscriptions.toast.archivedError.description': 'Could not move subscription to archive.',
  'subscriptions.toast.removedError.title': 'Delete failed',
  'subscriptions.toast.removedError.description': 'Subscription was not deleted.',
  'archive.title': 'Archived subscriptions',
  'archive.emptyTitle': 'Archive is empty',
  'archive.emptyDescription': 'Rest easy knowing everything active is in the main list.',
  'archive.emptyAction': 'Back to subscriptions',
  'archive.confirmDeleteTitle': 'Delete archived subscription?',
  'archive.confirmDeleteDescription': 'This will permanently remove it from SubsKeeper.',
  'archive.confirmDeleteConfirm': 'Delete',
  'archive.toast.restored.title': 'Restored',
  'archive.toast.restored.description': 'Subscription is active again.',
  'archive.toast.deleted.title': 'Deleted',
  'archive.toast.deleted.description': 'Removed from archive.',
  'archive.toast.restoredError.title': 'Restore failed',
  'archive.toast.restoredError.description': 'Could not restore subscription.',
  'archive.toast.deletedError.title': 'Delete failed',
  'archive.toast.deletedError.description': 'Could not remove subscription from archive.',
  'subscriptionForm.name': 'Name',
  'subscriptionForm.namePlaceholder': 'Subscription name',
  'subscriptionForm.price': 'Price',
  'subscriptionForm.pricePlaceholder': '0.00',
  'subscriptionForm.paidThrough': 'Paid through',
  'subscriptionForm.status': 'Status',
  'subscriptionForm.vendor': 'Vendor',
  'subscriptionForm.vendorPlaceholder': 'Company',
  'subscriptionForm.category': 'Category',
  'subscriptionForm.categoryPlaceholder': 'Entertainment, work...',
  'subscriptionForm.notes': 'Notes',
  'subscriptionForm.notesPlaceholder': 'Anything worth remembering?',
  'subscriptionForm.cancel': 'Cancel',
  'subscriptionForm.save': 'Save subscription',
  'subscriptionForm.update': 'Update subscription',
  'subscriptionForm.statusIndicator': 'is currently set as',
  'subscriptionForm.newName': 'New subscription',
  'settings.title': 'Preferences',
  'settings.locale': 'Locale',
  'settings.localeOption.en': 'English',
  'settings.localeOption.ru': 'Russian',
  'settings.currency': 'Default currency',
  'settings.timezone': 'Timezone',
  'settings.reminderDays': 'Reminder window (days)',
  'settings.email': 'Email for reports',
  'settings.emailPlaceholder': 'you@example.com',
  'settings.telegram': 'Telegram bot linked',
  'settings.revert': 'Revert changes',
  'settings.save': 'Save settings',
  'settings.toast.saved.title': 'Settings saved',
  'settings.toast.saved.description': 'Preferences updated.',
  'newSubscription.title': 'New subscription',
  'newSubscription.toast.title': 'Added',
  'newSubscription.toast.description': '{name} is now tracked.',
  'newSubscription.toast.errorTitle': 'Could not add subscription',
  'newSubscription.toast.errorDescription': 'The subscription was not created. Please try again.',
  'editSubscription.title': 'Edit subscription',
  'editSubscription.toast.title': 'Updated',
  'editSubscription.toast.description': '{name} refreshed.',
  'editSubscription.toast.errorTitle': 'Could not update subscription',
  'editSubscription.toast.errorDescription': 'Changes were not saved. Please try again.',
  'editSubscription.missingTitle': 'Subscription missing',
  'editSubscription.missingDescription': 'We couldn’t find that subscription. It may have been deleted.',
  'editSubscription.back': 'Back to list',
  'confirm.cancel': 'Cancel',
  'confirm.confirm': 'Confirm',
} as const

type TranslationKey = keyof typeof en

type TranslationDictionary = Record<TranslationKey, string>

const ru: TranslationDictionary = {
  'app.loading': 'Загружаем ваши подписки...',
  'nav.dashboard': 'Главная',
  'nav.subscriptions': 'Подписки',
  'nav.archive': 'Архив',
  'nav.settings': 'Настройки',
  'nav.importJson': 'Импорт JSON',
  'nav.export': 'Экспорт',
  'nav.addSubscription': 'Добавить подписку',
  'nav.openMenu': 'Открыть меню',
  'nav.closeMenu': 'Закрыть меню',
  'nav.menuTitle': 'Меню навигации',
  'nav.exportReady.title': 'Экспорт готов',
  'nav.exportReady.description': 'Ваши подписки экспортированы в JSON.',
  'nav.importComplete.title': 'Импорт завершён',
  'nav.importComplete.description': 'Подписки загружены из файла.',
  'nav.importFailed.title': 'Ошибка импорта',
  'nav.importFailed.description': 'Не удалось прочитать файл. Убедитесь, что это корректный экспорт SubsKeeper.',
  'nav.importFailed.invalidJson': 'Файл содержит некорректный JSON.',
  'nav.importFailed.invalidStructure': 'Структура файла не соответствует экспорту SubsKeeper.',
  'nav.importFailed.empty': 'Файл пуст. Сначала экспортируйте данные перед импортом.',
  'nav.tagline': 'Контролируйте все регулярные платежи с удобством',
  'import.ariaLabel': 'Импортировать подписки из JSON',
  'footer.offline': 'работает полностью офлайн. Ваши данные остаются в браузере.',
  'footer.tagline': 'Создано с заботой о разумных тратах.',
  'filters.searchLabel': 'Поиск',
  'filters.searchPlaceholder': 'Название, поставщик, заметки...',
  'filters.sortLabel': 'Сортировка',
  'filters.sort.nextDue': 'Ближайшая оплата',
  'filters.sort.priceDesc': 'Цена по убыванию',
  'filters.sort.priceAsc': 'Цена по возрастанию',
  'filters.sort.name': 'По алфавиту',
  'filters.sort.createdAt': 'Недавно добавленные',
  'filters.statusLabel': 'Статус',
  'filters.status.all': 'Все',
  'filters.categoryLabel': 'Категория',
  'filters.category.any': 'Любая',
  'filters.vendorLabel': 'Поставщик',
  'filters.vendor.any': 'Любой',
  'filters.minPrice': 'Минимальная цена',
  'filters.maxPrice': 'Максимальная цена',
  'filters.reset': 'Сбросить фильтры',
  'subscription.vendorUnknown': 'Поставщик не указан',
  'subscription.monthlyPrice': 'Ежемесячная стоимость',
  'subscription.nextRenewal': 'Следующее продление',
  'subscription.dueIn': 'через {count} дн.',
  'subscription.duePast': '{count} дн. назад',
  'subscription.category': 'Категория',
  'subscription.notes': 'Заметки',
  'subscription.edit': 'Редактировать',
  'subscription.archive': 'В архив',
  'subscription.restore': 'Восстановить',
  'subscription.delete': 'Удалить',
  'status.active': 'Активная',
  'status.canceled': 'Отменена',
  'status.expired': 'Истекла',
  'status.archived': 'В архиве',
  'stats.activeLineup': 'Активные подписки',
  'stats.archivedCount': '{count} в архиве',
  'stats.reminders': 'Напоминания',
  'stats.remindersDescription': 'Скоро истекают или уже просрочены по вашему окну напоминаний',
  'stats.monthlySpend': 'Ежемесячные расходы',
  'stats.monthlySpendEmpty': 'Добавьте подписки, чтобы увидеть суммы.',
  'stats.normalized': 'В пересчёте на USD',
  'stats.normalizedDescription': 'Используется фиксированная таблица курсов внутри приложения.',
  'sparkline.title': 'Динамика за 12 месяцев',
  'sparkline.empty': 'Добавьте подписки, чтобы увидеть график.',
  'reminders.queue': 'Очередь напоминаний',
  'reminders.badge': '{count} к оплате',
  'reminders.empty': 'Все напоминания выполнены! Измените окно напоминаний в настройках, чтобы увидеть будущие продления.',
  'reminders.due': 'Оплата {date}',
  'reminders.overdue': '{count} дн. просрочено',
  'reminders.left': '{count} дн. осталось',
  'reminders.review': 'Проверить',
  'reminders.snooze': 'Отложить на 7 дней',
  'reminders.clearSnooze': 'Снять отсрочку',
  'reminders.toast.snoozeError.title': 'Не удалось отложить',
  'reminders.toast.snoozeError.description': 'Не получилось перенести напоминание. Попробуйте ещё раз.',
  'reminders.toast.clearError.title': 'Не удалось снять напоминание',
  'reminders.toast.clearError.description': 'Обновите страницу и повторите попытку.',
  'toast.close': 'Закрыть',
  'subscriptions.emptyTitle': 'Подписок пока нет',
  'subscriptions.emptyDescription': 'Измените фильтры или добавьте первую подписку, чтобы начать.',
  'subscriptions.emptyAction': 'Добавить подписку',
  'subscriptions.confirmDeleteTitle': 'Удалить подписку?',
  'subscriptions.confirmDeleteDescription': 'Это действие нельзя отменить.',
  'subscriptions.confirmDeleteConfirm': 'Удалить',
  'subscriptions.toast.archived.title': 'Архивировано',
  'subscriptions.toast.archived.description': 'Подписка перемещена в архив.',
  'subscriptions.toast.removed.title': 'Удалено',
  'subscriptions.toast.removed.description': 'Подписка полностью удалена.',
  'subscriptions.toast.archivedError.title': 'Ошибка архивации',
  'subscriptions.toast.archivedError.description': 'Не удалось переместить подписку в архив.',
  'subscriptions.toast.removedError.title': 'Ошибка удаления',
  'subscriptions.toast.removedError.description': 'Подписку удалить не получилось.',
  'archive.title': 'Архив подписок',
  'archive.emptyTitle': 'Архив пуст',
  'archive.emptyDescription': 'Все активные подписки находятся в основном списке.',
  'archive.emptyAction': 'К списку подписок',
  'archive.confirmDeleteTitle': 'Удалить подписку из архива?',
  'archive.confirmDeleteDescription': 'Подписка будет полностью удалена из SubsKeeper.',
  'archive.confirmDeleteConfirm': 'Удалить',
  'archive.toast.restored.title': 'Восстановлено',
  'archive.toast.restored.description': 'Подписка снова активна.',
  'archive.toast.deleted.title': 'Удалено',
  'archive.toast.deleted.description': 'Удалено из архива.',
  'archive.toast.restoredError.title': 'Не удалось восстановить',
  'archive.toast.restoredError.description': 'Не получилось вернуть подписку из архива.',
  'archive.toast.deletedError.title': 'Не удалось удалить',
  'archive.toast.deletedError.description': 'Ошибка при удалении подписки из архива.',
  'subscriptionForm.name': 'Название',
  'subscriptionForm.namePlaceholder': 'Название подписки',
  'subscriptionForm.price': 'Стоимость',
  'subscriptionForm.pricePlaceholder': '0.00',
  'subscriptionForm.paidThrough': 'Оплачено до',
  'subscriptionForm.status': 'Статус',
  'subscriptionForm.vendor': 'Поставщик',
  'subscriptionForm.vendorPlaceholder': 'Компания',
  'subscriptionForm.category': 'Категория',
  'subscriptionForm.categoryPlaceholder': 'Развлечения, работа...',
  'subscriptionForm.notes': 'Заметки',
  'subscriptionForm.notesPlaceholder': 'Что стоит запомнить?',
  'subscriptionForm.cancel': 'Отмена',
  'subscriptionForm.save': 'Сохранить подписку',
  'subscriptionForm.update': 'Обновить подписку',
  'subscriptionForm.statusIndicator': 'имеет статус',
  'subscriptionForm.newName': 'Новая подписка',
  'settings.title': 'Предпочтения',
  'settings.locale': 'Язык интерфейса',
  'settings.localeOption.en': 'Английский',
  'settings.localeOption.ru': 'Русский',
  'settings.currency': 'Валюта по умолчанию',
  'settings.timezone': 'Часовой пояс',
  'settings.reminderDays': 'Окно напоминаний (дни)',
  'settings.email': 'Email для отчётов',
  'settings.emailPlaceholder': 'you@example.com',
  'settings.telegram': 'Подключён бот Telegram',
  'settings.revert': 'Отменить изменения',
  'settings.save': 'Сохранить настройки',
  'settings.toast.saved.title': 'Настройки сохранены',
  'settings.toast.saved.description': 'Предпочтения обновлены.',
  'newSubscription.title': 'Новая подписка',
  'newSubscription.toast.title': 'Добавлено',
  'newSubscription.toast.description': '«{name}» теперь отслеживается.',
  'newSubscription.toast.errorTitle': 'Не удалось добавить подписку',
  'newSubscription.toast.errorDescription': 'Создать подписку не получилось. Попробуйте снова.',
  'editSubscription.title': 'Редактирование подписки',
  'editSubscription.toast.title': 'Обновлено',
  'editSubscription.toast.description': 'Подписка {name} обновлена.',
  'editSubscription.toast.errorTitle': 'Не удалось обновить подписку',
  'editSubscription.toast.errorDescription': 'Изменения не сохранены. Попробуйте ещё раз.',
  'editSubscription.missingTitle': 'Подписка не найдена',
  'editSubscription.missingDescription': 'Не удалось найти эту подписку. Возможно, она была удалена.',
  'editSubscription.back': 'Вернуться к списку',
  'confirm.cancel': 'Отмена',
  'confirm.confirm': 'Подтвердить',
}

const translations: Record<Locale, TranslationDictionary> = {
  en,
  ru,
}

const templatePattern = /\{(\w+)\}/g

const interpolate = (template: string, values?: Record<string, string | number>) => {
  if (!values) return template
  return template.replace(templatePattern, (_, token) =>
    Object.prototype.hasOwnProperty.call(values, token) ? String(values[token]) : '',
  )
}

export const useI18n = () => {
  const locale = useStore((state) => state.settings.locale)

  return useMemo(() => {
    const dictionary = translations[locale] ?? translations.en
    const fallback = translations.en

    const translate = (key: TranslationKey, values?: Record<string, string | number>) => {
      const template = dictionary[key] ?? fallback[key]
      return interpolate(template, values)
    }

    return {
      locale,
      t: translate,
      formatDate: (iso?: string | null, options?: { formatStr?: string }) =>
        formatDateUtil(iso, { locale, formatStr: options?.formatStr }),
      formatRelativeToNow: (iso?: string | null) => formatRelativeToNowUtil(iso, locale),
      formatMonthLabel: (iso: string) => formatMonthLabelUtil(iso, locale),
    }
  }, [locale])
}

export type { TranslationKey }
